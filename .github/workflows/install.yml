name: Build, install and deploy to AWS

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment"
        required: true
        type: choice
        options:
          - "prod"
          - "test"
        default: "test"
      ref:
        description: "Branch/tag/SHA of digitraffic-cdk-private"
        required: true
        default: "master"
      config-repo-branch:
        description: "Branch or tag of CI-repo"
        required: true
        default: "master"
      command:
        description: "Command for cdk"
        required: true
        type: choice
        options: 
          - "deploy"
          - "diff"
        default: "deploy"

      application:
        description: "Application to install"
        required: true
        type: choice
        options: 
          - "digitraffic-statistics"
          - "aton-faults"
          - "bridge-lock-disruptions"
          - "marinecam"
          - "port-call"
          - "port-activity"
          - "sea-state-estimate"
          - "shiplight"
          - "winter-navigation"
          - "counting-site"

jobs:
  build_and_deploy:
    if: ${{ github.repository != 'tmfg/digitraffic-cdk' }}
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
      actions: read
    environment: ${{ github.event.inputs.env }}

    steps:
      - name: Summary
        run: |
          echo '### Running ${{ github.event.inputs.command }} ${{ github.event.inputs.application }} to ${{ github.event.inputs.env }}! ðŸš€' >> $GITHUB_STEP_SUMMARY
          echo 'Using ref ${{ github.event.inputs.ref }}' >> $GITHUB_STEP_SUMMARY
          echo 'Using ci ${{ github.event.inputs.config-repo-branch }}' >> $GITHUB_STEP_SUMMARY

      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Checkout CI-repo
        uses: actions/checkout@v6
        with:
          repository: ${{ secrets.CONFIG_REPO_NAME }}
          ssh-key: ${{ secrets.CONFIG_REPO_SSH_KEY }}
          ref: ${{ inputs.config-repo-branch }}
          path: digitraffic-ci

      - name: Set environment variables
        id: environment
        run: |
            export DOMAIN=${{ fromJson(secrets.INSTALL_CONFIG).projects[github.event.inputs.application].domain }}
            export STACK=${{ fromJson(secrets.INSTALL_CONFIG).projects[github.event.inputs.application].stack }}
            export DIRECTORY=${{ fromJson(secrets.INSTALL_CONFIG).projects[github.event.inputs.application].directory }}

            # by default, directory is same as domain
            if [ "$DIRECTORY" == "" ]; then
                export DIRECTORY=$DOMAIN
            fi

            echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
            echo "stack=$STACK" >> $GITHUB_OUTPUT
            echo "dir=$DIRECTORY" >> $GITHUB_OUTPUT
            echo "directory=$DIRECTORY/${{ github.event.inputs.application }}" >> $GITHUB_OUTPUT
            echo "generateSbom=${{ fromJson(secrets.INSTALL_CONFIG).projects[github.event.inputs.application].runGenerateSbom }}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ fromJson(secrets.INSTALL_CONFIG).roles[github.event.inputs.env][steps.environment.outputs.domain] }}
          role-session-name: gh-actions-install-${{ github.event.inputs.env }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup Node.js 24
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm 10
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Rush Install
        run: node common/scripts/install-run-rush.js install

      - name: Copy config
        run: |
          mkdir ${{ steps.environment.outputs.directory }}/src/bin

          if [ "${{ fromJson(secrets.INSTALL_CONFIG).projects[github.event.inputs.application].allConfigs }}" == "true" ]; then
              cp digitraffic-ci/aws/cdk/marine/config.ts ${{ steps.environment.outputs.directory }}/src/bin/config-marine.ts 
              cp digitraffic-ci/aws/cdk/road/config.ts ${{ steps.environment.outputs.directory }}/src/bin/config-road.ts 
              cp digitraffic-ci/aws/cdk/rail/config.ts ${{ steps.environment.outputs.directory }}/src/bin/config-rail.ts 
              cp digitraffic-ci/aws/cdk/aviation/config.ts ${{ steps.environment.outputs.directory }}/src/bin/config-aviation.ts 
          else
              # file might not exist, so skipping errors 
              cp digitraffic-ci/aws/cdk/${{ steps.environment.outputs.dir }}/config.ts ${{ steps.environment.outputs.directory }}/src/bin/ || true
          fi

          cp digitraffic-ci/aws/cdk/${{ steps.environment.outputs.directory }}/* ${{ steps.environment.outputs.directory }}/src/bin/

      - name: Diff and deploy
        id: deploy
        env:
          ENV: ${{ github.event.inputs.env }}
          STACK: ${{ steps.environment.outputs.stack }}
        run: |                  
            if [ $ENV == "prod" ]; then export STACK_NAME=${STACK}Prod; else export STACK_NAME=${STACK}Test; fi;
 
            # skip environment suffix on stack name if configured
            if [ "true" == "${{ fromJson(secrets.INSTALL_CONFIG).projects[github.event.inputs.application].skipEnvironmentOnStackName }}" ]; then
                export STACK_NAME=${STACK}
            fi;

            node common/scripts/install-run-rush.js rebuild --to ${{ github.event.inputs.application }}

            cd ${{ steps.environment.outputs.directory }}
            # and the run command
            node ../../common/scripts/install-run-rush-pnpm.js cdk ${{ github.event.inputs.command }} $STACK_NAME

            if [ "${{ steps.environment.outputs.generateSbom }}" == "true" ] && [ "${{ github.event.inputs.command }}" == "deploy" ]; then
              export IMAGE_URL=$(aws cloudformation describe-stacks \
                --region ${{ secrets.AWS_REGION }} \
                --stack-name $STACK_NAME \
                --query "Stacks[0].Outputs[?OutputKey=='ImageUrl'].OutputValue" \
                --output text)

              echo "IMAGE_URL=$IMAGE_URL" >> $GITHUB_OUTPUT
            fi;

      - name: Generate SBOM
        if: github.event.inputs.command == 'deploy' && steps.environment.outputs.generateSbom == 'true'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: image
          image-ref: ${{ steps.deploy.outputs.IMAGE_URL }}
          format: cyclonedx
          scanners: vuln,license
          version: latest
          output: ${{ steps.environment.outputs.directory }}/sbom.json

      - name: Configure AWS credentials for SBOM
        if: github.event.inputs.command == 'deploy'
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.SBOM_AWS_ROLE }}
          role-session-name: gh-actions-upload-sbom-${{ github.event.inputs.application }}-${{ github.event.inputs.env }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload SBOM
        if: github.event.inputs.command == 'deploy'
        run: |
          aws s3 cp ${{ steps.environment.outputs.directory }}/sbom.json s3://${{ secrets.SBOM_BUCKET }}/${{ fromJson(secrets.SBOM_PROJECT_KEYS)[github.event.inputs.env][github.event.inputs.application] }}/${{ github.run_id }}-${{ github.sha }}.json

      - name: Notify Slack
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: FAILED ${{ github.event.inputs.application }} install on ${{ github.event.inputs.env }}
          fields: repo, job, took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
